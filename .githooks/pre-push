#!/bin/sh
# Pre-push hook for running GUT tests
# This hook runs the GUT test suite before pushing to remote repository
# to catch issues early before CI runs.
#
# To bypass this hook (not recommended): git push --no-verify

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "${BLUE}========================================${NC}"
echo "${BLUE}Running GUT Tests (Pre-Push Hook)${NC}"
echo "${BLUE}========================================${NC}"
echo ""

# Check if Godot is available in PATH
if ! command -v godot &> /dev/null; then
    echo "${YELLOW}‚ö†Ô∏è  Warning: Godot not found in PATH${NC}"
    echo "${YELLOW}‚ö†Ô∏è  Skipping local tests - they will run in CI instead${NC}"
    echo ""
    echo "${BLUE}‚ÑπÔ∏è  To run tests locally, ensure Godot 4.3+ is installed and in your PATH${NC}"
    echo "${BLUE}‚ÑπÔ∏è  Download from: https://godotengine.org/download${NC}"
    echo ""
    exit 0
fi

# Verify Godot version
GODOT_VERSION=$(godot --version 2>/dev/null | head -n 1)
echo "${BLUE}‚ÑπÔ∏è  Using: ${GODOT_VERSION}${NC}"
echo ""

# Step 1: Import project assets
echo "${BLUE}üì¶ Importing project assets...${NC}"
if godot --headless --path . --import --quit 2>&1 | grep -i "error" > /dev/null; then
    echo "${YELLOW}‚ö†Ô∏è  Asset import completed with warnings (this is often normal)${NC}"
else
    echo "${GREEN}‚úÖ Asset import complete${NC}"
fi
echo ""

# Step 2: Run GUT tests
echo "${BLUE}üß™ Running GUT test suite...${NC}"
echo "${BLUE}   Test directory: res://scripts/tests/${NC}"
echo "${BLUE}   This may take 1-3 minutes...${NC}"
echo ""

# Run tests with proper environment and flags
if GODOT_DISABLE_LEAK_CHECKS=1 godot --headless -d --display-driver headless \
    --audio-driver Dummy --disable-render-loop --path . \
    -s res://addons/gut/gut_cmdln.gd \
    -gdir=res://scripts/tests/ -ginclude_subdirs -gexit; then

    echo ""
    echo "${GREEN}========================================${NC}"
    echo "${GREEN}‚úÖ All tests passed!${NC}"
    echo "${GREEN}========================================${NC}"
    echo "${GREEN}Proceeding with push...${NC}"
    echo ""
    exit 0
else
    echo ""
    echo "${RED}========================================${NC}"
    echo "${RED}‚ùå Tests failed!${NC}"
    echo "${RED}========================================${NC}"
    echo ""
    echo "${YELLOW}Push aborted to prevent pushing failing code.${NC}"
    echo ""
    echo "${BLUE}Options:${NC}"
    echo "  1. Fix the failing tests and try again (recommended)"
    echo "  2. Use 'git push --no-verify' to bypass this check (not recommended)"
    echo ""
    echo "${BLUE}‚ÑπÔ∏è  Note: Tests will also run in CI/CD on GitHub Actions${NC}"
    echo ""
    exit 1
fi
